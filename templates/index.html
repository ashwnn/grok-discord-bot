{% extends "base.html" %}
{% block title %}Guilds - Chad Bot Admin{% endblock %}

{% block content %}
<div class="page-header">
  <h2>Chad Bot Admin</h2>
  <p class="page-subtitle">Configure and manage your Discord guild's bot instance</p>
</div>

{% if guilds %}
<div class="guild-list">
  <h3 class="section-title">Your Guilds</h3>
  <div class="guilds-grid">
    {% for guild in guilds %}
    <div class="guild-card-container">
      <div class="guild-card">
        <a href="/guilds/{{ guild.id }}" class="guild-card-link">
          {% if guild.icon_url %}
            <img src="{{ guild.icon_url }}" alt="{{ guild.name }}" class="guild-icon-image">
          {% else %}
            <div class="guild-icon">{{ guild.name[0] | upper }}</div>
          {% endif %}
          <p class="guild-name">{{ guild.name }}</p>
          <p class="guild-id">{{ guild.id }}</p>
          <p class="guild-link">Manage â†’</p>
        </a>
        <button class="btn btn-delete-guild" onclick="deleteGuild('{{ guild.id }}', event)" title="Delete this guild from database">Delete</button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% else %}
<div class="card getting-started">
  <h3>Getting Started</h3>
  <p class="card-description">Set up your first guild to get started</p>
  
  <ol class="steps-list">
    <li>
      <strong>Add the bot to your Discord guild</strong>
      <p>Invite the Chad Bot to your Discord server</p>
    </li>
    <li>
      <strong>Run the bot once</strong>
      <p>Use any command in your guild to initialize the configuration</p>
    </li>
    <li>
      <strong>Grant yourself admin rights</strong>
      <p>Run this command in your database:</p>
      <div class="code-block">
        <code>sqlite3 chad.sqlite3 "INSERT OR IGNORE INTO admin_users (discord_user_id, guild_id) VALUES ('YOUR_ID', 'GUILD_ID');"</code>
      </div>
    </li>
    <li>
      <strong>Refresh this page</strong>
      <p>Your guild should appear in the list above</p>
    </li>
  </ol>
  
  <p class="help-text">Need more help? Check the README.md for detailed instructions.</p>
</div>
{% endif %}

<style>
  .page-header {
    margin-bottom: 40px;
  }

  .page-header h2 {
    margin: 0 0 8px 0;
    font-size: 2.5rem;
  }

  .page-subtitle {
    margin: 0;
    color: var(--color-text-muted);
    font-size: 1.1rem;
  }

  .section-title {
    margin: 0 0 20px 0;
    font-size: 1.25rem;
    font-weight: 600;
  }

  .guilds-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px;
  }

  .guild-card-container {
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .guild-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 24px 16px;
    background: white;
    border: 2px solid var(--color-border-base);
    border-radius: 12px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
    cursor: pointer;
    flex: 1;
    position: relative;
  }

  .guild-card:hover {
    border-color: var(--color-blue-500);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
  }

  .guild-card-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: inherit;
    flex: 1;
    width: 100%;
  }

  .guild-icon {
    width: 48px;
    height: 48px;
    background: var(--color-blue-500);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.25rem;
  }

  .guild-icon-image {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    background: var(--color-blue-500);
  }

  .guild-name {
    margin: 0;
    font-weight: 600;
    font-size: 1rem;
  }

  .guild-id {
    margin: 0;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    word-break: break-all;
  }

  .guild-link {
    margin: 8px 0 0 0;
    color: var(--color-blue-500);
    font-weight: 500;
    font-size: 0.9rem;
  }

  .btn-delete-guild {
    margin-top: 8px;
    background: var(--color-text-danger);
    border-color: var(--color-text-danger);
    padding: 8px 12px;
    font-size: 0.8rem;
    width: 100%;
  }

  .btn-delete-guild:hover {
    background: #b91c1c;
    border-color: #b91c1c;
  }

  .guild-list {
    margin-bottom: 40px;
  }

  .getting-started {
    max-width: 600px;
  }

  .card-description {
    margin: 0 0 24px 0;
    color: var(--color-text-muted);
  }

  .steps-list {
    margin: 0;
    padding: 0;
    counter-reset: step-counter;
    list-style: none;
  }

  .steps-list li {
    counter-increment: step-counter;
    margin-bottom: 20px;
    padding-left: 40px;
    position: relative;
  }

  .steps-list li::before {
    content: counter(step-counter);
    position: absolute;
    left: 0;
    top: 0;
    width: 32px;
    height: 32px;
    background: var(--color-blue-500);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .steps-list li strong {
    display: block;
    margin-bottom: 4px;
    font-size: 1rem;
  }

  .steps-list li p {
    margin: 0;
    color: var(--color-text-muted);
    font-size: 0.95rem;
  }

  .code-block {
    margin-top: 8px;
    padding: 12px;
    background: var(--color-bg-app);
    border-radius: 6px;
    border-left: 3px solid var(--color-blue-500);
    overflow-x: auto;
  }

  .code-block code {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    color: var(--color-text-muted);
    word-break: break-all;
  }

  .help-text {
    margin: 24px 0 0 0;
    padding: 12px 16px;
    background: #dbeafe;
    border-radius: 6px;
    color: #0c4a6e;
    font-size: 0.9rem;
  }

  @media (max-width: 768px) {
    .page-header h2 {
      font-size: 1.75rem;
    }

    .guilds-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
async function deleteGuild(guildId, event) {
  event.stopPropagation();
  
  if (!confirm(`Are you sure you want to delete the configuration for guild ${guildId}? This action cannot be undone.`)) {
    return;
  }

  try {
    const res = await fetch(`/api/guilds/${guildId}`, {
      method: "DELETE",
    });

    if (res.ok) {
      alert("Guild deleted successfully");
      location.reload();
    } else {
      const error = await res.json();
      alert(`Failed to delete guild: ${error.detail || "Unknown error"}`);
    }
  } catch (err) {
    alert(`Error deleting guild: ${err.message}`);
  }
}
</script>
{% endblock %}
